class FormSerializer{static serialize(form_element){let data={};for(let i=0,count=form_element.elements.length;i<count;i++){let element=form_element.elements[i];if(!element.name)continue;if(element.getAttribute("autocomplete")==="off")continue;if(element.tagName==="SELECT"){data[element.name]=new Array;for(let j=0;j<element.selectedOptions.length;j++)data[element.name].push(element.selectedOptions.item(j).value)}else{if(element.tagName!=="BUTTON"&&element.type!=="password"&&element.type!=="file"&&element.type!=="checkbox"&&element.type!=="radio"&&element.type!=="submit"&&element.type!=="button"&&element.type!=="reset"){if(element.name.includes("[]")){if(!data.hasOwnProperty(element.name))data[element.name]=new Array;data[element.name].push(element.value)}else data[element.name]=element.value}if(element.type==="checkbox"){if(!data.hasOwnProperty(element.name))data[element.name]=new Array;if(element.checked)data[element.name].push(element.value)}if(element.type==="radio"&&element.checked===true)data[element.name]=element.value}}return data}static unserialize(data,form_element){for(const field in data){const elements=form_element.querySelectorAll('[name="'+field+'"]');for(let i=0;i<elements.length;i++){const element=elements[i];if(element!==null){if(element.tagName==="SELECT"){for(let j=0;j<element.options.length;j++)element.options.item(j).selected=data[field].includes(element.options.item(j).value)}else{if(element.type!=="password"&&element.type!=="file"&&element.type!=="checkbox"&&element.type!=="radio"){element.value=data[field]}if(element.type==="checkbox"){element.checked=data[field].includes(element.value)}if(element.type==="radio")element.checked=data[field]==element.value}}}}}}class FormStorage{constructor(form_element,options){if(!form_element instanceof HTMLFormElement)throw Error("Parameter form_element is not HTML form!");this.form_element=form_element;if(typeof options.storage_key!=="string")throw Error("Option storage_key is not string!");this.storage_key=options.storage_key;form_element.addEventListener("submit",this.processFormSubmit.bind(this));this.headers=options.headers;if(options.wait_input==true){this.save_mode=null;this.form_element.addEventListener("input",e=>{if(this.save_mode===null)this.save_mode=true})}else this.save_mode=true;if(options.save_on_exit==undefined)options.save_on_exit=true;if(options.save_on_exit===true)window.addEventListener("pagehide",this.save.bind(this));if(options.autosave_time===undefined)options.autosave_time=10;if(typeof options.autosave_time==="number"&&options.autosave_time>0)setInterval(this.save.bind(this),1e3*options.autosave_time);if(options.skip_autoloading!==true)this.load()}processFormSubmit(e){e.preventDefault();this.save();const formData=new FormData(this.form_element);const xhr=new XMLHttpRequest;xhr.open(this.form_element.method,this.form_element.action,true);if(typeof this.headers==="object")for(const header in this.headers)xhr.setRequestHeader(header,this.headers[header]);const self=this;xhr.onload=function(){if(xhr.status<400){window.localStorage.removeItem(self.storage_key);self.save_mode=false}else self.save_mode=true;this.onSubmitResult(xhr)}.bind(this);xhr.send(formData)}onBeforeSave(){}onSave(data){}onLoad(data){}onSubmitResult(xhr){function gotoURL(url){var new_url=new URL(url);new_url.hash="";var old_url=new URL(window.location);old_url.hash="";window.location.href=url;if(new_url.href==old_url.href)window.location.reload()}if(xhr.status===200||xhr.status===206||xhr.status===204){gotoURL(xhr.responseURL)}else if(xhr.status===201||xhr.status===302||xhr.status===303){gotoURL(xhr.getResponseHeader("Location"))}else{this.onSubmitError(xhr)}}onSubmitError(xhr){console.error("Error sending form data:",xhr.statusText)}onDecodeError(data){}save(){this.onBeforeSave();if(this.save_mode){let data=FormSerializer.serialize(this.form_element);if(data){this.onSave(data);window.localStorage.setItem(this.storage_key,JSON.stringify(data))}}}load(){let data=window.localStorage.getItem(this.storage_key);if(data===null)return;try{data=JSON.parse(data);this.onLoad(data);FormSerializer.unserialize(data,this.form_element)}catch(error){this.onDecodeError(data,error)}}}
